{% extends 'pragmatic-seo/_layout' %}
{% import "_includes/forms" as forms %}

{% set title = 'Images'|t('pragmatic-seo') %}
{% set selectedTab = 'images' %}

{% set crumbs = [
  { label: 'SEO', url: url('pragmatic-seo') },
  { label: 'Images'|t('pragmatic-seo'), url: url('pragmatic-seo/images') },
] %}

{% block content %}
  {% css %}
    .img-preview-wrap { position: relative; display: inline-block; }
    .img-preview-popover {
      display: none;
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 10px;
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      padding: 6px;
      z-index: 100;
      pointer-events: none;
      white-space: nowrap;
    }
    .img-preview-popover img {
      display: block;
      max-width: 200px;
      max-height: 200px;
      width: auto;
      height: auto;
      border-radius: 4px;
    }
    .img-preview-wrap:hover .img-preview-popover { display: block; }
  {% endcss %}

  <form id="images-filter-form" method="get" action="{{ url('pragmatic-seo/images') }}" accept-charset="UTF-8" style="margin-bottom: 16px;">
    <input type="hidden" name="page" value="1">
    <input type="hidden" id="used-filter-value" name="used" value="{{ usedOnly ? 1 : 0 }}">
    <div class="flex" style="gap: 12px; align-items: flex-end;">
      {{ forms.lightswitchField({
        id: 'used-only',
        name: 'usedSwitch',
        on: usedOnly,
        value: 1,
        label: 'Show only used images'|t('pragmatic-seo'),
      }) }}
      <div>
        <label for="perPage">{{ 'Per page'|t('pragmatic-seo') }}</label>
        <div class="select">
          <select id="perPage" name="perPage">
            {% for option in [50, 100, 250] %}
              <option value="{{ option }}" {{ option == perPage ? 'selected' : '' }}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </form>

  {% if rows is empty %}
    <p>{{ 'No images to show with the current filter.'|t('pragmatic-seo') }}</p>
  {% else %}
    <table class="data fullwidth">
      <thead>
        <tr>
          <th>{{ 'Used'|t('pragmatic-seo') }}</th>
          <th>{{ 'Asset'|t('pragmatic-seo') }}</th>
          <th>{{ 'Title'|t('pragmatic-seo') }}</th>
          {% for column in textColumns %}
            <th>{{ column.name }}</th>
          {% endfor %}
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          {% set asset = row.asset %}
          {% set rowFormId = 'save-asset-' ~ asset.id %}
          <tr>
            <td>
              {% if row.isUsed %}
                <span class="status enabled"></span>{{ 'Yes'|t('pragmatic-seo') }}
              {% else %}
                <span class="status"></span>{{ 'No'|t('pragmatic-seo') }}
              {% endif %}
            </td>
            <td>
              <span class="img-preview-wrap">
                <a href="{{ asset.cpEditUrl }}" class="js-open-asset" data-asset-id="{{ asset.id }}" data-site-id="{{ asset.siteId }}">{{ asset.filename }}</a>
                {% if asset.url %}
                  <span class="img-preview-popover">
                    <img src="{{ asset.url }}" alt="{{ asset.title }}" loading="lazy">
                  </span>
                {% endif %}
              </span><br>
              <code>ID {{ asset.id }}</code>
            </td>
            <td>
              {{ forms.text({
                form: rowFormId,
                name: "assets[#{asset.id}][title]",
                value: asset.title,
              }) }}
            </td>
            {% for column in textColumns %}
              {% set value = row.fieldValues[column.handle] ?? null %}
              <td>
                {% if value is same as(null) %}
                  <span class="light">-</span>
                {% elseif column.handle == '__native_alt__' %}
                  {{ forms.textarea({
                    form: rowFormId,
                    name: "assets[#{asset.id}][fields][#{column.handle}]",
                    value: value,
                    rows: 3,
                  }) }}
                {% else %}
                  {{ forms.text({
                    form: rowFormId,
                    name: "assets[#{asset.id}][fields][#{column.handle}]",
                    value: value,
                  }) }}
                {% endif %}
              </td>
            {% endfor %}
            <td>
              <button type="submit" class="btn submit" form="{{ rowFormId }}" name="saveRowId" value="{{ asset.id }}">{{ 'Save row'|t('pragmatic-seo') }}</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% for row in rows %}
      {% set asset = row.asset %}
      {% set rowFormId = 'save-asset-' ~ asset.id %}
      <form id="{{ rowFormId }}" method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('pragmatic-seo/default/save-images') }}
        {{ redirectInput(url('pragmatic-seo/images', {
          used: usedOnly ? 1 : 0,
          perPage: perPage,
          page: page
        })) }}
      </form>
    {% endfor %}

    <div class="flex justify-between align-center" style="margin-top: 16px;">
      <div>{{ total }} {{ 'total'|t('pragmatic-seo') }}</div>
      <div class="flex" style="gap: 8px; align-items: center;">
        {% set prevPage = page > 1 ? page - 1 : 1 %}
        {% set nextPage = page < totalPages ? page + 1 : totalPages %}
        <a class="btn {{ page == 1 ? 'disabled' : '' }}" href="{{ url('pragmatic-seo/images', { used: usedOnly ? 1 : 0, perPage: perPage, page: prevPage }) }}">{{ 'Prev'|t('pragmatic-seo') }}</a>
        <div>{{ 'Page'|t('pragmatic-seo') }} {{ page }} / {{ totalPages }}</div>
        <a class="btn {{ page == totalPages ? 'disabled' : '' }}" href="{{ url('pragmatic-seo/images', { used: usedOnly ? 1 : 0, perPage: perPage, page: nextPage }) }}">{{ 'Next'|t('pragmatic-seo') }}</a>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% js %}
  const imagesFilterForm = document.getElementById('images-filter-form');
  const usedOnlySwitch = imagesFilterForm?.querySelector('#used-only')
    || imagesFilterForm?.querySelector('input[type="checkbox"][name="usedSwitch"]')
    || imagesFilterForm?.querySelector('.lightswitch input[type="checkbox"]');
  const usedOnlySwitchWrapper = imagesFilterForm?.querySelector('.lightswitch');
  const usedFilterValue = imagesFilterForm?.querySelector('#used-filter-value');
  const perPageSelect = imagesFilterForm?.querySelector('select[name="perPage"]');
  const pageInput = imagesFilterForm?.querySelector('input[name="page"]');
  function submitWithSwitchValue() {
    if (!imagesFilterForm || !usedOnlySwitch) return;
    if (usedFilterValue) usedFilterValue.value = usedOnlySwitch.checked ? '1' : '0';
    if (pageInput) pageInput.value = '1';
    imagesFilterForm.submit();
  }

  if (imagesFilterForm && usedOnlySwitch) {
    usedOnlySwitch.addEventListener('change', submitWithSwitchValue);
    usedOnlySwitch.addEventListener('input', submitWithSwitchValue);
  }
  if (imagesFilterForm && usedOnlySwitchWrapper) {
    usedOnlySwitchWrapper.addEventListener('click', () => {
      // Craft toggles the underlying checkbox via JS; wait a tick before reading value.
      setTimeout(submitWithSwitchValue, 0);
    });
  }
  if (imagesFilterForm && perPageSelect) {
    perPageSelect.addEventListener('change', () => {
      if (pageInput) pageInput.value = '1';
      imagesFilterForm.submit();
    });
  }

  document.querySelectorAll('.js-open-asset').forEach((link) => {
    link.addEventListener('click', (event) => {
      if (typeof Craft === 'undefined' || typeof Craft.createElementEditor !== 'function') {
        return;
      }

      event.preventDefault();
      const assetId = parseInt(link.dataset.assetId || '0', 10);
      const siteId = parseInt(link.dataset.siteId || '0', 10);
      if (!assetId || !siteId) {
        return;
      }

      Craft.createElementEditor('craft\\elements\\Asset', $(link), {
        elementId: assetId,
        siteId: siteId,
      });
    });
  });
{% endjs %}
