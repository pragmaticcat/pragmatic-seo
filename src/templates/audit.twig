{% extends 'pragmatic-seo/_layout' %}

{% set title = 'Audit'|t('pragmatic-seo') %}
{% set selectedTab = 'audit' %}

{% set crumbs = [
  { label: 'SEO', url: url('pragmatic-seo') },
  { label: 'Audit'|t('pragmatic-seo'), url: url('pragmatic-seo/audit') },
] %}

{% block sidebar %}
  <nav aria-label="{{ 'Sections'|t('pragmatic-seo') }}">
    <ul class="nav">
      <li>
        <a class="{{ not sectionId ? 'sel' : '' }}" href="{{ url('pragmatic-seo/audit', { site: selectedSite.handle }) }}">
          {{ 'All entries'|t('pragmatic-seo') }}
        </a>
      </li>
      {% if sections|length %}
        <li class="heading"><span>{{ 'Sections'|t('pragmatic-seo') }}</span></li>
        {% for section in sections %}
          <li>
            <a class="{{ section.id == sectionId ? 'sel' : '' }}" href="{{ url('pragmatic-seo/audit', { site: selectedSite.handle, section: section.id }) }}">
              {{ section.name }} <span class="light ms-2">({{ section.count }})</span>
            </a>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  </nav>
{% endblock %}

{% block content %}
  {% css %}
    .seo-status {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .seo-status-ok   { background: #dcfce7; color: #166534; }
    .seo-status-warn { background: #fef3c7; color: #92400e; }
    .seo-status-error{ background: #fee2e2; color: #991b1b; }
    .seo-checks { display: flex; flex-wrap: wrap; gap: 6px; }
    .seo-check {
      font-size: 11px; border-radius: 999px;
      padding: 2px 8px; background: #eef2ff; color: #3730a3;
    }
    .seo-check.bad { background: #fef2f2; color: #b91c1c; }
  {% endcss %}

  {% if rows is empty %}
    <p class="light">{{ 'No entries with an SEO field in this section.'|t('pragmatic-seo') }}</p>
  {% else %}
    <div class="flex" style="align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
      <button id="run-audit-btn" class="btn danger" type="button">
        {{ 'Run audit'|t('pragmatic-seo') }}
      </button>
      <div id="audit-status-filter" style="display:none;">
        <div class="select">
          <select id="audit-status-select">
            <option value="all">{{ 'All statuses'|t('pragmatic-seo') }}</option>
            <option value="error" id="opt-error">{{ 'Errors'|t('pragmatic-seo') }}</option>
            <option value="warn"  id="opt-warn">{{ 'Warnings'|t('pragmatic-seo') }}</option>
            <option value="ok"    id="opt-ok">OK</option>
          </select>
        </div>
      </div>
      <span id="audit-progress" style="display:none; color:#6b7280;">
        {{ 'Running audit…'|t('pragmatic-seo') }}
      </span>
      <p id="audit-truncated-notice" class="light" style="display:none; margin:0;"></p>
    </div>

    <table id="audit-table" class="data fullwidth">
      <thead>
        <tr>
          <th>{{ 'Entry'|t('pragmatic-seo') }}</th>
          <th>{{ 'Status'|t('pragmatic-seo') }}</th>
          <th>{{ 'Checks'|t('pragmatic-seo') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr data-entry-id="{{ row.entryId }}" data-status="">
            <td>
              <a href="#" class="js-entry-slideout" data-entry-id="{{ row.entryId }}" data-site-id="{{ row.entrySiteId }}">{{ row.entryTitle }}</a>
              <div class="light"><code>ID {{ row.entryId }}</code></div>
            </td>
            <td class="js-audit-status"><span class="light">—</span></td>
            <td class="js-audit-checks"></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% js %}
    (function() {
      var checkTooltips = {
        title:       '{{ 'Missing final title. Define an SEO title or ensure the entry has a title.'|t('pragmatic-seo')|e('js') }}',
        description: '{{ 'Missing SEO description. Add one to improve search result snippets.'|t('pragmatic-seo')|e('js') }}',
        canonical:   '{{ 'Could not resolve a canonical URL for this entry.'|t('pragmatic-seo')|e('js') }}',
        image:       '{{ 'No SEO image. Recommended for improved social sharing.'|t('pragmatic-seo')|e('js') }}',
        robots:      '{{ 'Check the robots directive for this page.'|t('pragmatic-seo')|e('js') }}',
        jsonLd:      '{{ 'JSON-LD disabled in options for this language/site.'|t('pragmatic-seo')|e('js') }}',
        hreflang:    '{{ 'Not enough localised variants detected to emit hreflang.'|t('pragmatic-seo')|e('js') }}',
      };

      var btn             = document.getElementById('run-audit-btn');
      var progressEl      = document.getElementById('audit-progress');
      var statusFilter    = document.getElementById('audit-status-filter');
      var statusSelect    = document.getElementById('audit-status-select');
      var truncatedNotice = document.getElementById('audit-truncated-notice');
      var optError        = document.getElementById('opt-error');
      var optWarn         = document.getElementById('opt-warn');
      var optOk           = document.getElementById('opt-ok');
      var labelError      = '{{ 'Errors'|t('pragmatic-seo')|e('js') }}';
      var labelWarn       = '{{ 'Warnings'|t('pragmatic-seo')|e('js') }}';

      function applyFilter(filter) {
        document.querySelectorAll('#audit-table tbody tr[data-entry-id]').forEach(function(tr) {
          var status = tr.getAttribute('data-status');
          var show = filter === 'all' || status === filter || status === '';
          tr.style.display = show ? '' : 'none';
        });
      }

      function renderResult(row) {
        var tr = document.querySelector('#audit-table tbody tr[data-entry-id="' + row.entryId + '"]');
        if (!tr) return;

        tr.setAttribute('data-status', row.status);

        var statusLabel = row.status === 'ok' ? 'OK'
          : (row.status === 'warn' ? '{{ 'Warning'|t('pragmatic-seo')|e('js') }}'
          : '{{ 'Error'|t('pragmatic-seo')|e('js') }}');
        var statusTitle = row.status === 'warn'
          ? '{{ 'There are recommended SEO warnings to improve visibility.'|t('pragmatic-seo')|e('js') }}'
          : (row.status === 'error'
            ? '{{ 'There are important SEO errors that should be fixed soon.'|t('pragmatic-seo')|e('js') }}'
            : '');

        tr.querySelector('.js-audit-status').innerHTML =
          '<span class="seo-status seo-status-' + row.status + '"'
          + (statusTitle ? ' title="' + statusTitle.replace(/"/g, '&quot;') + '"' : '')
          + '>' + statusLabel + '</span>';

        var checksHtml = '<div class="seo-checks">';
        Object.keys(row.checks).forEach(function(key) {
          var passed = row.checks[key];
          var tip = passed ? '' : (checkTooltips[key] || '');
          var cls = passed ? 'seo-check' : 'seo-check bad';
          var titleAttr = (!passed && tip) ? ' title="' + tip.replace(/"/g, '&quot;') + '"' : '';
          checksHtml += '<span class="' + cls + '"' + titleAttr + '>' + key + ': ' + (passed ? 'ok' : 'fail') + '</span>';
        });
        checksHtml += '</div>';
        tr.querySelector('.js-audit-checks').innerHTML = checksHtml;
      }

      function runAudit() {
        if (btn) btn.setAttribute('disabled', 'disabled');
        if (progressEl) progressEl.style.display = '';

        var params = new URLSearchParams(window.location.search);
        var url = Craft.getCpUrl('pragmatic-seo/audit/run') + '?' + params.toString();

        fetch(url, {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then(function(r) { if (!r.ok) throw new Error('Request failed'); return r.json(); })
          .then(function(data) {
            // Update each row in-place
            Object.values(data.rows || {}).forEach(renderResult);

            // Update status filter counts
            var counts = { ok: 0, warn: 0, error: 0 };
            Object.values(data.rows || {}).forEach(function(r) {
              if (counts[r.status] !== undefined) counts[r.status]++;
            });
            if (optError) optError.textContent = labelError + ' (' + counts.error + ')';
            if (optWarn)  optWarn.textContent  = labelWarn  + ' (' + counts.warn  + ')';
            if (optOk)    optOk.textContent    = 'OK (' + counts.ok + ')';

            if (data.truncated && truncatedNotice) {
              truncatedNotice.textContent = '{{ 'Audited %scanned% of %total% entries to maintain performance.'|t('pragmatic-seo')|e('js') }}'
                .replace('%scanned%', data.scannedEntries)
                .replace('%total%', data.totalEntries);
              truncatedNotice.style.display = '';
            }

            if (statusFilter) statusFilter.style.display = '';
            applyFilter(statusSelect ? statusSelect.value : 'all');
          })
          .catch(function() {
            if (window.Craft && Craft.cp && typeof Craft.cp.displayError === 'function') {
              Craft.cp.displayError('{{ 'Failed to run audit. Please try again.'|t('pragmatic-seo')|e('js') }}');
            }
          })
          .finally(function() {
            if (btn) btn.removeAttribute('disabled');
            if (progressEl) progressEl.style.display = 'none';
          });
      }

      if (btn) btn.addEventListener('click', runAudit);

      if (statusSelect) {
        statusSelect.addEventListener('change', function() { applyFilter(statusSelect.value); });
      }

      // Entry slideouts
      document.querySelectorAll('.js-entry-slideout').forEach(function(link) {
        link.addEventListener('click', function(ev) {
          ev.preventDefault();
          var entryId = parseInt(link.getAttribute('data-entry-id') || '0', 10);
          var siteId  = parseInt(link.getAttribute('data-site-id')  || '0', 10);
          if (!entryId || !window.Craft || typeof Craft.createElementEditor !== 'function') return;
          Craft.createElementEditor('craft\\elements\\Entry', {
            elementId: entryId,
            siteId: siteId || undefined,
            slideout: true,
          });
        });
      });
    })();
  {% endjs %}
{% endblock %}
